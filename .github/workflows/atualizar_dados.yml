name: Pipeline Di√°rio de Risco e Chuva Incremental

# Gatilhos: O YML pode ser acionado manualmente ou pelos agendamentos dos jobs
on:
  workflow_dispatch:

# --- JOB 1: Atualiza√ß√£o R√°pida de Dados de Chuva (A cada 5 minutos) ---
jobs:
  pipeline_chuva_incremental:
    name: üåßÔ∏è 1. Chuva Incremental (A cada 5 minutos)
    runs-on: ubuntu-latest
    
    # Agendamento de 5 em 5 minutos
    schedule:
      - cron: '*/5 * * * *'

    env:
      CEMADEN_EMAIL: ${{ secrets.CEMADEN_EMAIL }}
      CEMADEN_SENHA: ${{ secrets.CEMADEN_SENHA }}

    steps:
      - name: Checkout do Reposit√≥rio
        uses: actions/checkout@v4
      - name: Configurar Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Instalar depend√™ncias
        # Removido 'requests' e 'pytz' pois n√£o s√£o necess√°rios para 'atualizar_dados.py'
        run: pip install pandas

      - name: Rodar script de atualiza√ß√£o de dados
        run: python atualizar_dados.py

      - name: Fazer commit e push das altera√ß√µes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add 'chuva_recife_*.csv'
          # Garante que NENHUM outro arquivo seja comitado (previne erro se o 'risco' for gerado acidentalmente)
          git reset -- 'resultado_risco_final.csv' || true
          git commit -m "Dados de chuva atualizados automaticamente" || exit 0
          git push

# --- JOB 2: C√°lculo de Risco e Envio Di√°rio de Hist√≥rico (Fim do dia) ---
  pipeline_risco_diario:
    name: üìä 2. C√°lculo e Incremento de Risco (Di√°rio √†s 23:59)
    runs-on: ubuntu-latest
    
    # Agendado para rodar √†s 23:59 em Recife (02:59 UTC)
    schedule:
      - cron: '59 2 * * *' 

    env:
      CEMADEN_EMAIL: ${{ secrets.CEMADEN_EMAIL }}
      CEMADEN_SENHA: ${{ secrets.CEMADEN_SENHA }}

    steps:
      - name: Checkout do Reposit√≥rio
        uses: actions/checkout@v4
      - name: Configurar Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Instalar depend√™ncias (Completo)
        # requests, pytz e numpy s√£o necess√°rios para baixar o hist√≥rico e calcular o risco
        run: pip install requests pandas pytz numpy 
        
      # O JOB 1 j√° rodou e salvou o arquivo de chuva, agora o JOB 2 o utiliza.
      
      - name: ‚öôÔ∏è Executar 'calcular_risco_cli.py' (Calcula e incrementa o hist√≥rico)
        run: python calcular_risco_cli.py
        
      - name: üöÄ Enviar 'resultado_risco_final.csv' para o Reposit√≥rio do Painel
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.REPO_DESTINO_TOKEN }} 
          # O reposit√≥rio de destino
          repository: 'RafaellaB/Painel-Diagrama-de-Risco' 
          branch: 'main' 
          # Envia SOMENTE o arquivo de hist√≥rico completo.
          file_pattern: 'resultado_risco_final.csv'
          commit_message: 'Incremento di√°rio de risco: Adicionado dado do dia que encerrou.'