name: 游늵 2. C치lculo e Incremento de Risco (Di치rio 맙 23:59)

on:
  schedule:
    - cron: '59 2 * * *' # 23:59 em Recife (UTC-3)
  workflow_dispatch:

jobs:
  pipeline_risco_diario:
    runs-on: ubuntu-latest
    
    env:
      CEMADEN_EMAIL: ${{ secrets.CEMADEN_EMAIL }}
      CEMADEN_SENHA: ${{ secrets.CEMADEN_SENHA }}

    steps:
      - name: Checkout do Reposit칩rio
        uses: actions/checkout@v4
        
      - name: Configurar Python e Instalar depend칡ncias (Completo)
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - run: pip install requests pandas pytz numpy 
        
      - name: 丘뙖잺 Executar 'calcular_risco_cli.py' (Calcula e incrementa o hist칩rico)
        # O script de risco l칡 o arquivo de chuva que o JOB 1 salvou no 칰ltimo ciclo.
        run: python calcular_risco_cli.py
        
      # --- PASSO NOVO: ENVIO USANDO COMANDOS GIT PUROS ---
      - name: 游 Enviar 'resultado_risco_final.csv' para o Reposit칩rio do Painel
        run: |
          # 1. Configura as credenciais (usando o token de destino)
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # 2. Clona o reposit칩rio de destino para uma subpasta tempor치ria (usando o PAT)
          DEST_REPO="RafaellaB/Painel-Diagrama-de-Risco"
          DEST_BRANCH="main"
          
          # URL com o token inserido
          REPO_URL="https://${{ secrets.REPO_DESTINO_TOKEN }}@github.com/${DEST_REPO}.git"
          
          # Clona e entra na pasta
          git clone --single-branch --branch ${DEST_BRANCH} ${REPO_URL} destino_repo
          cd destino_repo
          
          # 3. Copia o arquivo gerado (risco_final.csv) para o reposit칩rio clonado
          cp ../resultado_risco_final.csv .
          
          # 4. Faz o commit e push
          git add resultado_risco_final.csv
          
          # Permite que o push falhe sem quebrar o job se n칚o houver altera칞칚o (|| exit 0)
          git commit -m "Incremento di치rio de risco: Adicionado dado do dia que encerrou." || exit 0
          git push origin ${DEST_BRANCH}