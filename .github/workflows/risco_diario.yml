name: 游늵 2. C치lculo e Incremento de Risco (Di치rio 맙 23:59)

on:
  schedule:
    - cron: '59 2 * * *' # 23:59 em Recife (UTC-3)
  workflow_dispatch:

jobs:
  pipeline_risco_diario:
    runs-on: ubuntu-latest
    
    env:
      CEMADEN_EMAIL: ${{ secrets.CEMADEN_EMAIL }}
      CEMADEN_SENHA: ${{ secrets.CEMADEN_SENHA }}

    steps:
      - name: Checkout do Reposit칩rio de Origem
        uses: actions/checkout@v4
        
      # --- PASSO NOVO: CONFIGURA칂츾O DE CREDENCIAIS GLOBAIS ---
      - name: Configurar Credenciais de Push (Token de Destino)
        run: |
          # Define o dom칤nio do GitHub para usar o Token como credencial HTTP
          git config --global url."https://${{ secrets.REPO_DESTINO_TOKEN }}@github.com/".insteadOf "https://github.com/"
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Configurar Python e Instalar depend칡ncias (Completo)
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - run: pip install requests pandas pytz numpy 
        
      - name: 丘뙖잺 Executar 'calcular_risco_cli.py' (Calcula e incrementa o hist칩rico)
        run: python calcular_risco_cli.py
        
      # --- PASSO FINAL: ENVIO DE DADOS PARA REPOSIT칍RIO DE DESTINO ---
      - name: 游 Enviar 'resultado_risco_final.csv' para o Reposit칩rio do Painel
        run: |
          DEST_REPO="RafaellaB/Painel-Diagrama-de-Risco"
          DEST_BRANCH="main"
          DEST_DIR="destino_repo"
          
          # Clona o reposit칩rio de destino (a autentica칞칚o j치 est치 configurada no passo anterior)
          git clone --single-branch --branch ${DEST_BRANCH} https://github.com/${DEST_REPO}.git ${DEST_DIR}
          cd ${DEST_DIR}

          # Copia o arquivo gerado da raiz
          cp ../resultado_risco_final.csv .

          # Faz o commit e push
          git add resultado_risco_final.csv
          
          # Commit e Push (o token 칠 lido da configura칞칚o global)
          git commit -m "Incremento di치rio de risco: Adicionado dado do dia que encerrou." || exit 0
          git push origin ${DEST_BRANCH}